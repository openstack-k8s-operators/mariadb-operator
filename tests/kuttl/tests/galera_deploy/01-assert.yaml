#
# Check for:
# - Galera CR
# - Galera StatefulSet
# - 3 Galera Pods
# - openstack-galera service
# - openstack-galera endpoints
# - openstack-config-data config map

apiVersion: mariadb.openstack.org/v1beta1
kind: Galera
metadata:
  name: openstack
  namespace: openstack
spec:
  secret: osp-secret
  storageClass: local-storage
  storageRequest: 500M
  containerImage: quay.io/tripleozedcentos9/openstack-mariadb:current-tripleo
  replicas: 3
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: openstack-galera
  namespace: openstack
spec:
  replicas: 3
  selector:
    matchLabels:
      app: galera
      cr: galera-openstack
      galera/name: openstack
      galera/namespace: openstack
  serviceName: openstack-galera
  template:
    metadata:
      labels:
        app: galera
        cr: galera-openstack
        galera/name: openstack
        galera/namespace: openstack
    spec:
      containers:
      - command:
        - /usr/bin/dumb-init
        - --
        - /usr/local/bin/kolla_start
        image: quay.io/tripleozedcentos9/openstack-mariadb:current-tripleo 
        name: galera
        ports:
        - containerPort: 3306
          name: mysql
          protocol: TCP
        - containerPort: 4567
          name: galera
          protocol: TCP
      serviceAccount: mariadb-operator-mariadb
      serviceAccountName: mariadb-operator-mariadb
status:
  availableReplicas: 3
  readyReplicas: 3
  replicas: 3
---
apiVersion: v1
kind: Pod
metadata:
  name: openstack-galera-0
  namespace: openstack
---
apiVersion: v1
kind: Pod
metadata:
  name: openstack-galera-1
  namespace: openstack
---
apiVersion: v1
kind: Pod
metadata:
  name: openstack-galera-2
  namespace: openstack
---
apiVersion: v1
kind: Service
metadata:
  name: openstack-galera
  namespace: openstack
spec:
  ports:
  - name: mysql
    port: 3306
    protocol: TCP
    targetPort: 3306
  selector:
    app: galera
    cr: galera-openstack
---
apiVersion: v1
kind: Endpoints
metadata:
  name: openstack-galera
  namespace: openstack
---
apiVersion: v1
data:
  config.json: |
    {
        "command": "/usr/local/bin/detect_gcomm_and_start.sh",
        "config_files": [
            {
                "source": "/var/lib/pod-config-data/galera.cnf",
                "dest": "/etc/my.cnf.d/galera.cnf",
                "owner": "root",
                "perm": "0644"
            },
            {
                "source": "/var/lib/pod-config-data/galera_custom.cnf",
                "dest": "/etc/my.cnf.d/galera_custom.cnf",
                "owner": "root",
                "perm": "0644",
                "optional": true
            },
            {
                "source": "/var/lib/operator-scripts",
                "dest": "/usr/local/bin",
                "owner": "root",
                "perm": "0755",
                "merge": "true"
            }
        ],
        "permissions": [
            {
                "path": "/var/lib/mysql",
                "owner": "mysql:mysql",
                "recurse": "true"
            }
        ]
    }
  galera.cnf.in: |
    [client]
    port = 3306
    socket = /var/lib/mysql/mysql.sock

    [isamchk]
    key_buffer_size = 16M

    [mysqld]
    basedir = /usr
    bind-address = { PODNAME }
    binlog_format = ROW
    datadir = /var/lib/mysql
    default-storage-engine = innodb
    expire_logs_days = 10
    innodb_autoinc_lock_mode = 2
    innodb_file_per_table = ON
    innodb_flush_log_at_trx_commit = 1
    innodb_locks_unsafe_for_binlog = 1
    innodb_strict_mode = OFF
    key_buffer_size = 16M
    # log-error = /var/log/mariadb/mariadb.log
    max_allowed_packet = 16M
    max_binlog_size = 100M
    max_connections = 4096
    open_files_limit = 65536
    pid-file = /var/lib/mysql/mariadb.pid
    port = 3306
    query_cache_limit = 1M
    query_cache_size = 16M
    skip-external-locking
    skip-name-resolve = 1
    socket = /var/lib/mysql/mysql.sock
    thread_cache_size = 8
    thread_stack = 256K
    tmpdir = /tmp
    user = mysql
    wsrep_auto_increment_control = 1
    wsrep_causal_reads = 0
    wsrep_certify_nonPK = 1
    # wsrep_cluster_address = gcomm://database-0.internalapi.redhat.local,database-1.internalapi.redhat.local,database-2.internalapi.redhat.local
    wsrep_cluster_name = galera_cluster
    wsrep_convert_LOCK_to_trx = 0
    wsrep_debug = 0
    wsrep_drupal_282555_workaround = 0
    wsrep_on = ON
    wsrep_provider = /usr/lib64/galera/libgalera_smm.so
    wsrep_provider_options = gmcast.listen_addr=tcp://{ PODIP }:4567
    wsrep_retry_autocommit = 1
    wsrep_slave_threads = 1
    wsrep_sst_method = rsync

    [mysqld_safe]
    # log-error = /var/log/mariadb/mariadb.log
    nice = 0
    pid-file = /var/lib/mysql/mariadb.pid
    socket = /var/lib/mysql/mysql.sock

    [mysqldump]
    max_allowed_packet = 16M
    quick
    quote-names
  galera_custom.cnf.in: ""
kind: ConfigMap
metadata:
  name: openstack-config-data
  namespace: openstack
