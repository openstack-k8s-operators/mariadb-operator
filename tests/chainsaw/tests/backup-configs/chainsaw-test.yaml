apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: backup-configs
spec:
  steps:
  - name: setup a 1-node cluster and a backup CR with dedicated logical PVC
    description: prechecks that backup CR is correctly set up
    bindings:
    - name: replicas
      value: 1
    try:
    - apply:
        file: ../../common/tls-certificate.yaml
    - apply:
        file: ../../common/galera-tls.yaml
    - apply:
        file: galerabackup-two-pvc.yaml
    - assert:
        file: ../../common/galera-assert.yaml
    - script:
        content: oc -n $NAMESPACE get pvc mysql-db-openstack-galera-0 -o json
        skipLogOutput: true
        outputs:
        - name: dbpvc
          value: (json_parse($stdout))
    - assert:
        file: galerabackup-two-pvc-assert.yaml

  - name: backup the 1-node Galera cluster
    description: checks that the cluster is correctly backed up
    bindings:
    - name: replicas
      value: "1"
    try:
    - script:
        env:
        - name: REPLICAS
          value: ($replicas)
        content: |
          oc -n $NAMESPACE create job --from=cronjob/openstack-backup-openstack backup-${REPLICAS}node
          oc -n $NAMESPACE wait --for=condition=complete job/backup-${REPLICAS}node
    - script:
        env:
        - name: REPLICAS
          value: ($replicas)
        content: |
          ../../common/backup-assert.sh backup-${REPLICAS}node
