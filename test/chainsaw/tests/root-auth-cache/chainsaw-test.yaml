apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: root-auth-cache
spec:
  steps:
  - name: Deploy 1-node cluster
    description: Deploy a 1-node cluster for tests
    bindings:
    - name: replicas
      value: 1
    try:
    - apply:
        file: ../../common/galera.yaml
    - assert:
        file: ../../common/galera-assert.yaml

  - name: verify mysql_pw_cache.cnf created
    description: Verify that mysql_pw_cache.cnf is created after first mysql_root_auth.sh invocation
    try:
    - script:
        content: |
          oc exec -n ${NAMESPACE} -c galera openstack-galera-0 -- /bin/sh -c '
            source /var/lib/operator-scripts/mysql_root_auth.sh
            test -f /var/local/my.cnf/mysql_pw_cache.cnf
          '

  - name: verify mysql_pw_cache.cnf format
    description: Verify mysql_pw_cache.cnf has proper MySQL client format
    try:
    - script:
        content: |
          oc exec -n ${NAMESPACE} -c galera openstack-galera-0 -- /bin/sh -c '
            grep -q "^\[client\]" /var/local/my.cnf/mysql_pw_cache.cnf &&
            grep -q "^user=root" /var/local/my.cnf/mysql_pw_cache.cnf &&
            grep -q "^password=" /var/local/my.cnf/mysql_pw_cache.cnf
          '

  - name: verify mysql_pw_cache.cnf permissions
    description: Verify mysql_pw_cache.cnf has secure permissions (600)
    try:
    - script:
        content: |
          oc exec -n ${NAMESPACE} -c galera openstack-galera-0 -- /bin/sh -c '
            perms=$(stat -c "%a" /var/local/my.cnf/mysql_pw_cache.cnf)
            test "$perms" = "600"
          '

  - name: verify we can in theory use the file like a my.cnf file
    description: Verify MySQL commands work using mysql_pw_cache.cnf without MYSQL_PWD env var
    try:
    - script:
        content: |
          oc exec -n ${NAMESPACE} -c galera openstack-galera-0 -- /bin/sh -c '
            unset MYSQL_PWD
            mysql -e "SELECT 1" > /dev/null
          '

  - name: verify we can in theory use the file like a my.cnf file with mysqladmin
    description: Verify mysqladmin ping works using mysql_pw_cache.cnf
    try:
    - script:
        content: |
          oc exec -n ${NAMESPACE} -c galera openstack-galera-0 -- /bin/sh -c '
            unset MYSQL_PWD
            mysqladmin ping > /dev/null
          '

  - name: verify caching works
    description: Verify mysql_root_auth.sh can be sourced multiple times successfully
    try:
    - script:
        content: |
          oc exec -n ${NAMESPACE} -c galera openstack-galera-0 -- /bin/sh -c '
            source /var/lib/operator-scripts/mysql_root_auth.sh
            source /var/lib/operator-scripts/mysql_root_auth.sh
            source /var/lib/operator-scripts/mysql_root_auth.sh
            echo "Sourced 3 times successfully"
          '

  - name: verify env vars still exported
    description: Verify MYSQL_PWD and DB_ROOT_PASSWORD are still exported after sourcing
    try:
    - script:
        content: |
          oc exec -n ${NAMESPACE} -c galera openstack-galera-0 -- /bin/sh -c '
            source /var/lib/operator-scripts/mysql_root_auth.sh
            test -n "$MYSQL_PWD" && test -n "$DB_ROOT_PASSWORD"
            echo "Both env vars are set"
          '

  - name: verify cache refresh on invalid credentials
    description: Verify that invalid credentials in mysql_pw_cache.cnf trigger a refresh
    try:
    - script:
        content: |
          oc exec -n ${NAMESPACE} -c galera openstack-galera-0 -- /bin/sh -c '
            # Write invalid credentials to mysql_pw_cache.cnf
            echo -e "[client]\nuser=root\npassword=wrongpassword" > /var/local/my.cnf/mysql_pw_cache.cnf
            # Source mysql_root_auth.sh - should detect invalid creds and refresh
            source /var/lib/operator-scripts/mysql_root_auth.sh
            # Verify MySQL works now (credentials were refreshed)
            mysql -e "SELECT 1" > /dev/null
            echo "Credentials refreshed successfully"
          '
